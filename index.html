<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VelkX</title>

<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0c1210; --panel:#0f1814; --panel2:#111e18; --text:#eaf7ef; --muted:#a8cdbb; --border:#1c2c24;
    --brand:#22c55e; --brand2:#16a34a; --brand3:#86efac; --ring:0 0 0 4px rgba(34,197,94,.28);
    --danger:#ef4444; --shadow1:0 10px 30px rgba(0,0,0,.35); --shadow2:0 18px 60px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:
      radial-gradient(1300px 700px at -10% -10%, #101a15 0%, var(--bg) 60%),
      radial-gradient(900px 500px at 120% 0%, #0e1713 0%, var(--bg) 60%);
  }

  /* Topbar */
  .topbar{
    height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 12px;
    border-bottom:1px solid #0e1512;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
    backdrop-filter: blur(8px);
  }
  .brand{display:flex; align-items:center; gap:10px}
  .logo{height:26px; width:26px; border-radius:8px; background:linear-gradient(135deg,var(--brand3),var(--brand2)); overflow:hidden}
  .logo img{width:100%; height:100%; object-fit:cover; display:block}
  .title{font-weight:800; letter-spacing:.4px}
  .controls{display:flex; gap:8px}

  /* Buttons / Inputs */
  .btn,.btn-ghost{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    height:40px; padding:0 14px; border-radius:12px; border:1px solid transparent; cursor:pointer;
    font-weight:700; transition:transform .06s, filter .18s, border-color .18s, background .18s;
  }
  .btn{background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#0a0f0c; box-shadow:0 1px 0 rgba(0,0,0,.12)}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
  .btn-ghost{background:var(--panel); color:var(--text); border-color:var(--border)}
  .btn-ghost:hover{background:var(--panel2)}
  .btn.small{height:34px; padding:0 10px; border-radius:10px; font-weight:600}

  .input{
    width:100%; height:48px; border-radius:14px; border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    color:var(--text); padding:0 46px 0 14px;
    transition:border-color .18s, box-shadow .18s, background .18s;
  }
  .input::placeholder{color:var(--muted)}
  .input:focus{outline:none; border-color:var(--brand); box-shadow:var(--ring); background:var(--panel2)}
  .input-wrap{position:relative}
  .eye{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px;
    border-radius:10px; border:1px solid var(--border); background:var(--panel); cursor:pointer;
  }
  .hint{color:var(--muted); font-size:12px}
  .err{color:var(--danger); font-weight:700; font-size:13px; min-height:18px}
  .caps{color:#f59e0b; font-size:12px; font-weight:700; margin-top:6px; display:none}

  /* Gate */
  .wrap{min-height:calc(100% - 56px); display:flex; align-items:center; justify-content:center; padding:32px}
  .card{
    width:100%; max-width:520px;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--border); border-radius:24px; padding:28px; position:relative; overflow:hidden;
    box-shadow:var(--shadow2); backdrop-filter: blur(8px); animation:cardIn .5s ease both;
  }
  @keyframes cardIn{from{transform:translateY(8px); opacity:0} to{transform:none; opacity:1}}
  h1{margin:0 0 8px; font-size:28px; letter-spacing:.2px}
  .subtitle{margin:0; color:var(--muted); font-size:14px}

  /* Player & picker */
  .player{display:none}
  .grid{
    --cols:1; display:grid; gap:16px; grid-template-columns:repeat(var(--cols), minmax(0,1fr)); padding:18px;
  }
  @media(min-width:680px){ .grid{ --cols:2 } }
  @media(min-width:1024px){ .grid{ --cols:3 } }

  .site{
    position:relative; border:1px solid var(--border); border-radius:18px; overflow:hidden; background:var(--panel);
    transition:transform .18s, box-shadow .18s, border-color .18s; box-shadow:var(--shadow1);
  }
  .site:hover{ transform:translateY(-3px); border-color:#214e39; box-shadow:0 16px 40px rgba(0,0,0,.4); }
  .thumb{ aspect-ratio:16/9; background:#0a0f0c; overflow:hidden; position:relative; }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; transform:scale(1.02); transition:transform .35s ease; }
  .site:hover .thumb img{ transform:scale(1.06); }
  .gloss{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,.55) 100%) }
  .meta{
    position:absolute; left:12px; right:12px; bottom:12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .name{ font-weight:800; letter-spacing:.2px; text-shadow:0 2px 10px rgba(0,0,0,.6) }
  .open{ background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#0b0f0c; font-weight:800; padding:8px 12px; border-radius:10px; border:1px solid #133321; }
  .body{ padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .badge{ font-size:11px; color:var(--muted); border:1px solid var(--border); padding:6px 8px; border-radius:999px; background:var(--panel2); }

  /* Admin */
  .admin{ display:none }
  .admin-wrap{ padding:18px }
  .kpis{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)); margin:12px 0 18px }
  .panel{ border:1px solid var(--border); border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); padding:14px }
  .kpi{ font-size:28px; font-weight:800 }
  .muted{ color:var(--muted) }

  .bars{ display:flex; gap:6px; align-items:flex-end; height:92px }
  .bar{ flex:1; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:6px; position:relative }
  .bar::after{ content:attr(data-v); position:absolute; bottom:100%; left:50%; transform:translate(-50%,0); font-size:10px; color:var(--muted) }
</style>
</head>
<body>

<!-- Topbar (always visible) -->
<div class="topbar" id="topbar">
  <div class="brand">
    <div class="logo" id="logoBox"></div>
    <div class="title">VelkX Player</div>
  </div>
  <div class="controls">
    <a class="btn-ghost small" href="#/">Home</a>
    <a class="btn-ghost small" href="#/admin67">Admin</a>
    <button class="btn small" id="openDirect" style="display:none">Open here</button>
    <button class="btn-ghost small" id="toPicker" style="display:none">Site Picker</button>
  </div>
</div>

<!-- Gate (only password field) -->
<div class="wrap" id="gate">
  <div class="card" id="gateCard">
    <h1>Enter VelkX</h1>
    <p class="subtitle">Type the access password.</p>

    <div class="input-wrap" style="margin-top:16px">
      <input id="pw" class="input" type="password" inputmode="text" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button type="button" class="eye" id="toggleEye" aria-label="Show password">üëÅÔ∏è</button>
    </div>
    <div class="caps" id="capsHint">Caps Lock is ON</div>

    <button class="btn" id="enterBtn" style="width:100%; margin-top:14px">Enter</button>
    <div class="err" id="err" style="margin-top:8px"></div>
    <div class="hint">Two wrong attempts opens a new tab to your redirect.</div>
  </div>
</div>

<!-- Player (picker or iframe) -->
<div class="player" id="player">
  <div id="picker" class="grid"></div>
  <iframe id="frame" referrerpolicy="no-referrer" style="display:none; width:100%; height:calc(100vh - 56px); border:0; background:#000"></iframe>
</div>

<!-- Admin page -->
<div class="admin" id="admin">
  <div class="admin-wrap">
    <div class="kpis">
      <div class="panel"><div class="muted">Currently Online</div><div class="kpi" id="kOnline">‚Äì</div></div>
      <div class="panel"><div class="muted">Total Visits</div><div class="kpi" id="kVisits">‚Äì</div></div>
      <div class="panel"><div class="muted">Total Pageviews</div><div class="kpi" id="kPV">‚Äì</div></div>
      <div class="panel"><div class="muted">Total Time</div><div class="kpi" id="kTime">‚Äì</div></div>
      <div class="panel"><div class="muted">Avg Session Time</div><div class="kpi" id="kAvg">‚Äì</div></div>
      <div class="panel"><div class="muted">Sessions</div><div class="kpi" id="kSessions">‚Äì</div></div>
    </div>

    <div class="panel">
      <div style="display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:8px">
        <strong>Last 7 days</strong>
        <div style="display:flex; gap:8px">
          <button class="btn-ghost small" data-days="7">7d</button>
          <button class="btn-ghost small" data-days="14">14d</button>
          <button class="btn-ghost small" data-days="30">30d</button>
          <button class="btn small" id="refreshStats">Refresh</button>
        </div>
      </div>
      <div class="subtitle">Visits</div>
      <div id="barsVisits" class="bars" style="margin-bottom:10px"></div>
      <div class="subtitle">Pageviews</div>
      <div id="barsPV" class="bars" style="margin-bottom:10px"></div>
      <div class="subtitle">Time (minutes)</div>
      <div id="barsTime" class="bars"></div>
    </div>
  </div>
</div>

<script>
  
  const PASSWORD   = "test";
  const FAIL_REDIRECT = "https://example.com/";
  const IMAGE_BASE = "https://raw.githubusercontent.com/thebronx132/velk-x/main/images/"; // your GitHub images folder
  const API_BASE   = "https://velk-x-api.onrender.com"; // your Render API base URL
  const ADMIN_TOKEN = "300267"; // same as Render env ADMIN_TOKEN

  // Your catalog
  const SITES = [
    { name: "selenite",    url: "https://sixsevenn.alcrb.ru/",          img: IMAGE_BASE + "selenite.png" },
    { name: "MDN",       url: "https://developer.mozilla.org/",         img: IMAGE_BASE + "mdn.jpg" },
    { name: "Wikipedia", url: "https://en.wikipedia.org/",              img: IMAGE_BASE + "wikipedia.jpg" }
  ];

  // ====== DOM ======
  const gate   = document.getElementById('gate');
  const player = document.getElementById('player');
  const admin  = document.getElementById('admin');
  const picker = document.getElementById('picker');
  const frame  = document.getElementById('frame');
  const toPickerBtn = document.getElementById('toPicker');
  const openDirect  = document.getElementById('openDirect');
  const logoBox = document.getElementById('logoBox');

  // ====== Helpers ======
  function route() {
    // hash routing: "#/admin67" or "#/"
    const h = location.hash.replace(/^#\/?/, '');
    return h || '';
  }
  function show(view){
    gate.style.display   = (view==='gate')   ? 'flex'  : 'none';
    player.style.display = (view==='player') ? 'block' : 'none';
    admin.style.display  = (view==='admin')  ? 'block' : 'none';
  }
  function setLogo(){
    logoBox.innerHTML='';
    const img=document.createElement('img');
    img.src = IMAGE_BASE + 'velkx.png'; // put your logo file here
    img.alt = 'VelkX'; img.loading='lazy';
    logoBox.appendChild(img);
  }

  // ====== Password gate ======
  const pwInput  = document.getElementById('pw');
  const errEl    = document.getElementById('err');
  const enterBtn = document.getElementById('enterBtn');
  const toggleEye= document.getElementById('toggleEye');
  const capsHint = document.getElementById('capsHint');
  let attempts = 0;

  toggleEye.addEventListener('click', ()=>{
    const t = pwInput.type === 'password' ? 'text' : 'password';
    pwInput.type = t; toggleEye.textContent = (t==='text' ? 'üôà' : 'üëÅÔ∏è');
    pwInput.focus();
  });
  pwInput.addEventListener('keydown', (e)=>{
    if (e.getModifierState && e.getModifierState('CapsLock')) {
      capsHint.style.display='block';
    } else {
      capsHint.style.display='none';
    }
    if (e.key==='Enter') tryEnter();
  });

  function err(msg){
    errEl.textContent = msg;
    const card = document.getElementById('gateCard');
    card.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],
                 {duration:160, iterations:1});
  }
  function clearErr(){ errEl.textContent=''; }

  function tryEnter(){
    clearErr();
    const guess = (pwInput.value||'').trim();
    if (guess === PASSWORD){
      location.hash = '#/'; // ensure main route
      startPlayer();
      return;
    }
    attempts++;
    if (attempts>=2){
      err('Too many attempts. Redirecting‚Ä¶');
      const w = window.open(FAIL_REDIRECT, '_blank', 'noopener,noreferrer');
      if(!w) alert('Popup blocked. Allow popups for redirect.');
    } else {
      err('Incorrect password. Try again.');
    }
  }
  enterBtn.addEventListener('click', tryEnter);

  // ====== Picker UI ======
  function card(site){
    const el = document.createElement('div');
    el.className='site';
    el.innerHTML = `
      <div class="thumb">
        <img alt="">
        <div class="gloss"></div>
        <div class="meta">
          <div class="name">${site.name}</div>
          <button class="open">Open</button>
        </div>
      </div>
      <div class="body">
        <div class="badge">16:9 ‚Ä¢ Auto-fit</div>
        <div class="badge">Secure</div>
      </div>`;
    const img = el.querySelector('img');
    img.src = site.img; img.alt = site.name; img.loading='lazy';
    const open = ()=> openSite(site.url, site.name);
    el.querySelector('.open').addEventListener('click', open);
    el.addEventListener('click', (e)=>{ if(!e.target.closest('.open')) open(); });
    return el;
  }
  function renderPicker(){
    picker.innerHTML = '';
    SITES.forEach(s => picker.appendChild(card(s)));
    picker.style.display='grid';
    frame.style.display='none';
    toPickerBtn.style.display='inline-flex';
    openDirect.style.display='none';
  }

  // ====== Player flow ======
  let selectedURL = null;
  function openSite(url, name){
    selectedURL = url;
    frame.src = url;
    frame.style.display='block';
    picker.style.display='none';
    toPickerBtn.style.display='inline-flex';
    openDirect.style.display='inline-flex';

    // if embed is blocked, change button label after 2.5s
    let loaded=false;
    const onLoad=()=>{ loaded=true; frame.removeEventListener('load', onLoad); };
    frame.addEventListener('load', onLoad);
    setTimeout(()=>{ if(!loaded) openDirect.textContent='Open here (embed blocked)'; }, 2500);
  }
  document.getElementById('toPicker').addEventListener('click', renderPicker);
  document.getElementById('openDirect').addEventListener('click', ()=>{
    if (selectedURL) location.href = selectedURL;
  });

  function startPlayer(){
    setLogo();
    show('player');
    renderPicker();
    // optional analytics pings
    ping('/visit',{sid}); ping('/pageview',{sid, path:'home'});
    heartbeat = setInterval(()=> ping('/beat',{sid}), 15000);
    window.addEventListener('beforeunload', ()=> navigator.sendBeacon?.(`${API_BASE}/leave`, JSON.stringify({sid})));
  }

  // ====== Admin (basic view render; your API already supports richer stats) ======
  async function loadStats(days=7){
    try{
      const r = await fetch(`${API_BASE}/stats?days=${days}`); const j = await r.json();
      set('#kOnline', j.online); set('#kVisits', j.visits); set('#kPV', j.pageviews);
      set('#kTime', fmtDur(j.timeTotal)); set('#kAvg', fmtDur(j.avgSessionSec));
      set('#kSessions', j.sessions ?? '‚Äì');
      drawBars('barsVisits', j.daily.dates, j.daily.visits);
      drawBars('barsPV',     j.daily.dates, j.daily.pageviews);
      drawBars('barsTime',   j.daily.dates, j.daily.timeSec.map(s=>Math.round(s/60)));
    }catch(e){
      // hide panels if API is not set
    }
  }
  function set(sel,val){ const n=document.querySelector(sel); if(n) n.textContent = (typeof val==='number')? val.toLocaleString() : val; }
  function fmtDur(sec){ const s=Math.round(sec); const m=Math.floor(s/60), r=s%60; const h=Math.floor(m/60), mm=m%60; return h>0?`${h}h ${mm}m`:`${m}m ${r}s`; }
  function drawBars(id, labels, values){
    const wrap=document.getElementById(id); if(!wrap) return; wrap.innerHTML='';
    const max=Math.max(1,...values);
    values.forEach((v,i)=>{
      const h=Math.max(6, Math.round((v/max)*100));
      const b=document.createElement('div'); b.className='bar'; b.style.height=`${h}%`; b.setAttribute('data-v', v); b.title=`${labels[i]} ‚Äî ${v}`;
      wrap.appendChild(b);
    });
  }
  document.getElementById('refreshStats').addEventListener('click', ()=> loadStats(currentDays));
  document.querySelectorAll('[data-days]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ currentDays=Number(btn.dataset.days||7); loadStats(currentDays); });
  });

  // ====== Simple router (hash-based) ======
  let currentDays = 7, heartbeat=null;
  const sid = `${Date.now()}-${Math.random().toString(36).slice(2,8)}`;

  function navigate(){
    const r = route(); // '' or 'admin67'
    if (r === 'admin67'){
      // ADMIN
      clearInterval(heartbeat); heartbeat=null;
      show('admin'); setLogo();
      if (API_BASE) loadStats(7);
    } else {
      // MAIN (gate or already unlocked)
      show('gate');
      pwInput.focus();
    }
  }
  window.addEventListener('hashchange', navigate);

  // ====== Optional analytics helpers ======
  async function ping(path, body){
    if(!API_BASE) return;
    try { await fetch(`${API_BASE}${path}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) }); }
    catch {}
  }

  // Boot
  navigate(); // go to correct view for current hash
</script>
</body>
</html>

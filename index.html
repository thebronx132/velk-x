<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VelkX</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0c1210; --panel:#0f1814; --panel2:#111e18; --text:#eaf7ef; --muted:#a8cdbb; --border:#1c2c24;
    --brand:#22c55e; --brand2:#16a34a; --brand3:#86efac; --ring:0 0 0 4px rgba(34,197,94,.25);
    --danger:#ef4444; --shadow1:0 10px 30px rgba(0,0,0,.35); --shadow2:0 18px 60px rgba(0,0,0,.45);
    --warn:#f59e0b; --info:#3b82f6;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
    background:radial-gradient(1300px 700px at -10% -10%,#101a15 0%,var(--bg) 60%),radial-gradient(900px 500px at 120% 0%,#0e1713 0%,var(--bg) 60%);}
  .btn,.btn-ghost{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:40px;padding:0 14px;border-radius:12px;border:1px solid transparent;
    font-weight:700;cursor:pointer;transition:transform .06s,filter .18s,border-color .18s,background .18s}
  .btn{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0a0f0c;box-shadow:0 1px 0 rgba(0,0,0,.12)}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
  .btn-ghost{background:var(--panel);color:var(--text);border-color:var(--border)} .btn-ghost:hover{background:var(--panel2)}
  .btn.small{height:34px;padding:0 10px;border-radius:10px;font-weight:600}
  .input{width:100%;height:42px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:0 12px;
    transition:border-color .18s,box-shadow .18s,background .18s}
  .input::placeholder{color:var(--muted)} .input:focus{outline:none;border-color:var(--brand);box-shadow:var(--ring);background:var(--panel2)}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:32px}
  .card{width:100%;max-width:520px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:24px;padding:26px;
    position:relative;overflow:hidden;box-shadow:var(--shadow2);backdrop-filter:blur(8px);animation:cardIn .5s ease both}
  @keyframes cardIn{from{transform:translateY(8px);opacity:.0}to{transform:none;opacity:1}}
  .badge{position:absolute;right:16px;bottom:16px;background:linear-gradient(135deg,var(--brand3),var(--brand));color:#0b0f0c;font-weight:800;border-radius:999px;padding:6px 12px;font-size:12px;letter-spacing:.5px;text-transform:uppercase}
  h1{margin:0 0 8px;font-size:28px;letter-spacing:.2px}.subtitle{margin:0;color:var(--muted);font-size:14px}.err{color:var(--danger);font-weight:600;font-size:13px;min-height:18px}
  .topbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;border-bottom:1px solid #0e1512;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));backdrop-filter:blur(8px)}
  .brand{display:flex;align-items:center;gap:10px}.logo{height:26px;width:26px;border-radius:8px;background:linear-gradient(135deg,var(--brand3),var(--brand2));overflow:hidden}
  .title{font-weight:800;letter-spacing:.4px}.controls{display:flex;gap:8px}
  .player{display:none;position:fixed;inset:0;background:#000}
  iframe{border:0;display:block;width:100%;height:calc(100vh - 56px);background:#000}
  .picker{padding:18px;display:grid;gap:16px;grid-template-columns:repeat(1,minmax(0,1fr))}
  @media(min-width:680px){.picker{grid-template-columns:repeat(2,1fr)}} @media(min-width:1024px){.picker{grid-template-columns:repeat(3,1fr)}}
  .site-card{position:relative;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--panel);transition:transform .18s,box-shadow .18s,border-color .18s;box-shadow:var(--shadow1)}
  .site-card:hover{transform:translateY(-2px);border-color:#214e39;box-shadow:0 16px 40px rgba(0,0,0,.4)} .site-thumb{aspect-ratio:16/9;background:#0a0f0c;overflow:hidden}
  .site-thumb img{width:100%;height:100%;object-fit:cover;display:block;transform:scale(1.02);transition:transform .35s}.site-card:hover .site-thumb img{transform:scale(1.06)}
  .site-body{padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px}.site-title{font-weight:700}

  /* Announcement banner */
  .announce{position:sticky; top:0; z-index:50; display:none}
  .announce-inner{display:flex;align-items:center;gap:10px; padding:10px 12px; font-weight:700; border-bottom:1px solid var(--border)}
  .announce.info{background:#0f1914} .announce.warn{background:#1a1a0d} .announce.err{background:#190f0f}

  /* Admin page */
  .admin-wrap{padding:18px}
  .stat-grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr));margin:12px 0 18px}
  .panel{border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));padding:14px}
  .kpi{font-size:28px;font-weight:800}.muted{color:var(--muted)}
  .bars{display:flex;gap:6px;align-items:flex-end;height:80px}
  .bar{flex:1;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:6px;position:relative}
  .bar::after{content:attr(data-v);position:absolute;bottom:100%;left:50%;transform:translate(-50%,0);font-size:10px;color:var(--muted)}
</style>
</head>
<body>

<!-- Announcement -->
<div id="announce" class="announce">
  <div id="announceInner" class="announce-inner"></div>
</div>

<!-- Shared topbar -->
<div class="topbar" id="topbar" style="display:none">
  <div class="brand">
    <div class="logo" id="logoBox"></div>
    <div class="title">VelkX Player</div>
  </div>
  <div class="controls">
    <button class="btn-ghost small" id="toPicker" style="display:none">Site Picker</button>
    <button class="btn small" id="openDirect" style="display:none">Open here</button>
    <a class="btn-ghost small" href="/admin67">Admin</a>
  </div>
</div>

<!-- Gate (main route only) -->
<div class="wrap" id="gate">
  <div class="card">
    <div class="badge">VelkX</div>
    <h1>Enter VelkX</h1>
    <p class="subtitle">Type the access password to choose a site.</p>
    <div class="field"><label for="pw">Password</label><input id="pw" class="input" type="password" placeholder="••••••••"/></div>
    <button class="btn" id="enterBtn">Enter</button>
    <div class="field" style="display:flex;gap:10px;margin-top:12px">
      <button class="btn-ghost" id="helpBtn">Help</button>
      <button class="btn-ghost" id="aboutBtn">About</button>
    </div>
    <div class="err" id="err"></div>
    <div class="subtitle">Two wrong attempts opens a new tab to your redirect.</div>
  </div>
</div>

<!-- Player (picker or iframe) -->
<div class="player" id="player" style="display:none">
  <div id="pickerView" class="picker"></div>
  <iframe id="gameFrame" referrerpolicy="no-referrer" style="display:none"></iframe>
</div>

<!-- Admin page at /admin67 -->
<div id="adminPage" style="display:none">
  <div class="topbar" style="position:sticky;top:0;z-index:10">
    <div class="brand">
      <div class="logo" id="logoBoxAdmin"></div>
      <div class="title">VelkX Admin</div>
    </div>
    <div class="controls">
      <a class="btn-ghost small" href="/">Exit Admin</a>
    </div>
  </div>

  <div class="admin-wrap">
    <div class="stat-grid">
      <div class="panel"><div class="muted">Currently Online</div><div class="kpi" id="kpiOnline">–</div></div>
      <div class="panel"><div class="muted">Total Visits</div><div class="kpi" id="kpiVisits">–</div></div>
      <div class="panel"><div class="muted">Total Pageviews</div><div class="kpi" id="kpiPV">–</div></div>
      <div class="panel"><div class="muted">Total Time</div><div class="kpi" id="kpiTime">–</div></div>
      <div class="panel"><div class="muted">Avg Session Time</div><div class="kpi" id="kpiAvg">–</div></div>
      <div class="panel"><div class="muted">Sessions</div><div class="kpi" id="kpiSessions">–</div></div>
    </div>

    <div class="panel">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:8px">
        <strong>Last 7 days</strong>
        <div style="display:flex;gap:8px">
          <button class="btn-ghost small" data-days="7">7d</button>
          <button class="btn-ghost small" data-days="14">14d</button>
          <button class="btn-ghost small" data-days="30">30d</button>
          <button class="btn small" id="adminRefresh">Refresh</button>
        </div>
      </div>
      <div class="subtitle">Visits</div>
      <div id="barsVisits" class="bars" style="margin-bottom:10px"></div>
      <div class="subtitle">Pageviews</div>
      <div id="barsPV" class="bars" style="margin-bottom:10px"></div>
      <div class="subtitle">Time (minutes)</div>
      <div id="barsTime" class="bars"></div>
    </div>

    <div class="panel" style="margin-top:16px">
      <strong>Announcement</strong>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <input id="annMsg" class="input" placeholder="Type announcement to show at top of everyone’s screen"/>
        <select id="annLevel" class="input" style="max-width:180px">
          <option value="info">Info</option>
          <option value="warn">Warn</option>
          <option value="err">Error</option>
        </select>
        <button class="btn" id="annSave">Publish</button>
      </div>
      <div class="subtitle" id="annStatus" style="margin-top:6px"></div>
    </div>

    <div class="panel" style="margin-top:16px">
      <strong>Sites</strong>
      <div id="adminSites" class="picker" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG (EDIT THESE) ======
  const PASSWORD   = "test";
  const FAIL_REDIRECT = "https://example.com/";
  const IMAGE_BASE = "https://raw.githubusercontent.com/thebronx132/velk-x/main/images/"; // your GitHub images folder
  const API_BASE   = "https://velk-x-api.onrender.com"; // your Render API base URL
  const ADMIN_TOKEN = "300267"; // same as Render env ADMIN_TOKEN

  // Your catalog
  const SITES = [
    { name: "selenite",    url: "https://sixsevenn.alcrb.ru/",                   img: IMAGE_BASE + "selenite.png" },
    { name: "MDN",       url: "https://developer.mozilla.org/",         img: IMAGE_BASE + "mdn.jpg" },
    { name: "Wikipedia", url: "https://en.wikipedia.org/",              img: IMAGE_BASE + "wikipedia.jpg" }
  ];

// For hash routing
const isAdmin = location.hash.replace(/^#\/?/, '') === "admin67";


  // ====== DOM ======
  const announce = document.getElementById('announce');
  const announceInner = document.getElementById('announceInner');
  const topbar = document.getElementById('topbar');
  const player = document.getElementById('player');
  const gate = document.getElementById('gate');
  const pickerView = document.getElementById('pickerView');
  const frame = document.getElementById('gameFrame');
  const toPickerBtn = document.getElementById('toPicker');
  const openDirect = document.getElementById('openDirect');
  const logoBox = document.getElementById('logoBox');
  const logoBoxAdmin = document.getElementById('logoBoxAdmin');

  // ====== Announcement (SSE + fallback) ======
  function showAnnouncement(msg, level="info"){
    if (!msg) { announce.style.display="none"; return; }
    announce.className = `announce ${level}`;
    announceInner.textContent = msg;
    announce.style.display = "block";
  }
  async function fetchAnnouncement(){
    try{
      const r = await fetch(`${API_BASE}/announcement`);
      const j = await r.json();
      showAnnouncement(j.message, j.level);
    }catch{}
  }
  function sseAnnouncements(){
    try{
      const es = new EventSource(`${API_BASE}/ann-stream`);
      es.onmessage = (ev)=>{
        try {
          const j = JSON.parse(ev.data);
          showAnnouncement(j.message, j.level);
        } catch {}
      };
      es.onerror = ()=> { es.close(); setTimeout(sseAnnouncements, 5000); }; // retry
    }catch{}
  }

  // ====== Logo (from your GitHub images) ======
  function renderLogo(){
    [logoBox, logoBoxAdmin].forEach(box=>{
      if(!box) return;
      box.innerHTML = "";
      const img = document.createElement('img');
      img.src = IMAGE_BASE + "velkx.png";  // <= put your logo file here
      img.alt = "VelkX";
      img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover";
      box.appendChild(img);
    });
  }

  // ====== Picker ======
  function siteCard(site){
    const card = document.createElement('div');
    card.className = "site-card";
    card.innerHTML = `
      <div class="site-thumb"><img alt=""></div>
      <div class="site-body">
        <div class="site-title">${site.name}</div>
        <button class="btn small">Open</button>
      </div>`;
    const img = card.querySelector('img'); img.src = site.img; img.alt = site.name;
    const open = ()=> openSite(site.url, site.name);
    card.querySelector('.btn').addEventListener('click', open);
    card.addEventListener('click', e=>{ if(!e.target.closest('.btn')) open(); });
    return card;
  }
  function renderPicker(){
    pickerView.innerHTML = "";
    SITES.forEach(s => pickerView.appendChild(siteCard(s)));
    pickerView.style.display = "grid";
    frame.style.display = "none";
    toPickerBtn.style.display = "none";
    openDirect.style.display = "none";
  }

  // ====== Analytics (session heartbeat) ======
  let heartbeatTimer = null, selectedURL = null;
  const sid = `${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
  async function api(path, body){
    try {
      await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
    } catch {}
  }
  function startAnalytics(){
    api("/visit", { sid });
    api("/pageview", { sid, path: "home" });
    heartbeatTimer = setInterval(()=> api("/beat", { sid }), 15000);
    window.addEventListener('beforeunload', ()=> {
      try { navigator.sendBeacon(`${API_BASE}/leave`, JSON.stringify({sid})); } catch {}
    });
  }

  // ====== Player flow (main route) ======
  function toPlayer(){
    gate.style.display = "none";
    topbar.style.display = "flex";
    player.style.display = "block";
    renderLogo();
    renderPicker();
    startAnalytics();
  }
  function openSite(url, name){
    selectedURL = url;
    api("/pageview", { sid, path: `open:${name||url}` });
    frame.src = url;
    frame.style.display = "block";
    pickerView.style.display = "none";
    toPickerBtn.style.display = "inline-flex";
    openDirect.style.display = "inline-flex";
    let loaded=false;
    const onLoad=()=>{ loaded=true; frame.removeEventListener('load', onLoad); };
    frame.addEventListener('load', onLoad);
    setTimeout(()=>{ if(!loaded) openDirect.textContent="Open here (embed blocked)"; }, 2500);
  }

  // ====== Admin (advanced analytics + announcement) ======
  async function initAdmin(days=7){
    renderLogo();
    sseAnnouncements(); // admin sees updates too
    await loadStats(days);
    // sites listing preview
    const adminSites = document.getElementById('adminSites'); adminSites.innerHTML = "";
    SITES.forEach(s => adminSites.appendChild(siteCard(s)));

    // controls
    document.getElementById('adminRefresh').onclick = ()=> loadStats(days);
    document.querySelectorAll('[data-days]').forEach(b => {
      b.onclick = ()=> loadStats(Number(b.getAttribute('data-days')));
    });

    // announcement publish
    document.getElementById('annSave').onclick = async ()=>{
      const message = (document.getElementById('annMsg').value || "").trim();
      const level = document.getElementById('annLevel').value;
      if(!message){ alert("Type a message"); return; }
      try {
        const r = await fetch(`${API_BASE}/announcement`, {
          method: "POST",
          headers: {"Content-Type":"application/json", "X-Admin-Token": ADMIN_TOKEN},
          body: JSON.stringify({message, level})
        });
        if(!r.ok){ throw new Error("Failed"); }
        document.getElementById('annStatus').textContent = "Published ✓";
        setTimeout(()=> document.getElementById('annStatus').textContent = "", 2500);
      } catch {
        document.getElementById('annStatus').textContent = "Failed to publish";
      }
    };
  }

  function fmtDur(sec){
    const s = Math.round(sec); const m = Math.floor(s/60); const r = s%60;
    const h = Math.floor(m/60); const mm = m%60;
    return h>0 ? `${h}h ${mm}m` : `${m}m ${r}s`;
  }

  async function loadStats(days){
    try{
      const r = await fetch(`${API_BASE}/stats?days=${days}`); const j = await r.json();
      document.getElementById('kpiOnline').textContent   = j.online;
      document.getElementById('kpiVisits').textContent   = j.visits.toLocaleString();
      document.getElementById('kpiPV').textContent       = j.pageviews.toLocaleString();
      document.getElementById('kpiTime').textContent     = fmtDur(j.timeTotal);
      document.getElementById('kpiAvg').textContent      = fmtDur(j.avgSessionSec);
      document.getElementById('kpiSessions').textContent = j.sessions?.toLocaleString?.() ?? "–";

      // bars
      drawBars("barsVisits", j.daily.dates, j.daily.visits);
      drawBars("barsPV",     j.daily.dates, j.daily.pageviews);
      // convert seconds -> minutes (rounded)
      drawBars("barsTime",   j.daily.dates, j.daily.timeSec.map(x=>Math.round(x/60)));
    }catch(e){}
  }
  function drawBars(id, labels, values){
    const wrap = document.getElementById(id); wrap.innerHTML = "";
    const max = Math.max(1, ...values);
    values.forEach((v,i)=>{
      const h = Math.round((v / max) * 100);
      const b = document.createElement('div');
      b.className = "bar";
      b.style.height = `${Math.max(6,h)}%`;
      b.setAttribute('data-v', v);
      b.title = `${labels[i]} — ${v}`;
      wrap.appendChild(b);
    });
  }

  // ====== Boot ======
  sseAnnouncements(); // connect immediately (both routes)
  fetchAnnouncement(); // fallback
  const announcePing = setInterval(fetchAnnouncement, 60000); // backup refresh

  const isAdminRoute = location.pathname.replace(/\/+$/,'') === "/admin67";
  if (isAdminRoute){
    // ADMIN
    document.getElementById('gate').style.display = "none";
    document.getElementById('player').style.display = "none";
    document.getElementById('adminPage').style.display = "block";
    initAdmin(7);
  } else {
    // MAIN
    document.getElementById('topbar').style.display = "none";
    document.getElementById('player').style.display = "none";
    document.getElementById('pw').focus();

    // gate handlers
    const enterBtn = document.getElementById('enterBtn');
    const pwInput = document.getElementById('pw');
    let attempts = 0;
    function showError(msg){ document.getElementById('err').textContent = msg; }
    function clearErr(){ document.getElementById('err').textContent = ""; }
    function openRedirect(){ const w = window.open(FAIL_REDIRECT,'_blank','noopener,noreferrer'); if(!w) alert("Popup blocked"); }

    enterBtn.onclick = ()=>{
      clearErr();
      if ((pwInput.value||"").trim() === PASSWORD) { 
        toPlayer(); 
      } else {
        attempts++;
        attempts>=2 ? (showError("Too many attempts. Redirecting…"), openRedirect())
                    : showError("Incorrect password. Try again.");
      }
    };
    pwInput.addEventListener('keydown', e=>{ if(e.key==='Enter') enterBtn.click(); });
    document.getElementById('helpBtn').onclick  = ()=> alert("Enter the password to access the site picker.");
    document.getElementById('aboutBtn').onclick = ()=> alert("VelkX — green themed portal with picker and analytics.");
    document.getElementById('toPicker').onclick = ()=> renderPicker();
    document.getElementById('openDirect').onclick = ()=> { if(selectedURL) location.href = selectedURL; };
  }
</script>
</body>
</html>
